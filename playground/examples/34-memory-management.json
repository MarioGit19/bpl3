{
  "order": 34,
  "title": "Memory Management",
  "snippet": "Work with malloc, free, and memory allocation",
  "description": "BPL uses manual memory management - you control allocation and deallocation. malloc(size) allocates heap memory, returning void* (must cast). free(ptr) releases memory. Rules: every malloc needs a matching free, never use freed memory (use-after-free), don't free twice (double-free), don't free stack variables. Memory leaks occur when allocated memory is never freed. Use tools like valgrind to detect leaks. Strategies: RAII-style init/cleanup methods, ownership conventions, minimal malloc/free pairs. Heap memory persists until freed, unlike stack memory (auto-freed on scope exit). This example demonstrates safe memory management patterns and common pitfalls.",
  "code": [
    "extern printf(fmt: string, ...);",
    "extern malloc(size: long) ret *void;",
    "extern free(ptr: *void);",
    "",
    "# Define a simple structure for dynamic allocation",
    "struct Node {",
    "    value: int,",
    "    next: *Node,",
    "}",
    "",
    "frame createNode(value: int) ret *Node {",
    "    # Allocate memory for a Node",
    "    local size: long = sizeof(Node);",
    "    local ptr: *void = malloc(size);",
    "    ",
    "    # Cast void pointer to Node pointer",
    "    local node: *Node = cast<*Node>(ptr);",
    "    ",
    "    # Initialize the node",
    "    node.value = value;",
    "    node.next = nullptr;",
    "    ",
    "    return node;",
    "}",
    "",
    "frame printNodeValue(node: *Node) ret void {",
    "    printf(\"Node value: %d\\n\", node.value);",
    "}",
    "",
    "frame main() ret int {",
    "    printf(\"=== Memory Allocation Example ===\\n\");",
    "    ",
    "    # Allocate a single integer",
    "    local int_size: long = sizeof(int);",
    "    local int_ptr: *int = cast<*int>(malloc(int_size));",
    "    *int_ptr = 42;",
    "    printf(\"Allocated int: %d\\n\", *int_ptr);",
    "    free(cast<*void>(int_ptr));",
    "    ",
    "    # Allocate an array of integers (5 elements)",
    "    local arr_size: long = sizeof(int) * 5;",
    "    local arr_ptr: *int = cast<*int>(malloc(arr_size));",
    "    local i: int = 0;",
    "    loop (i < 5) {",
    "        *(arr_ptr + i) = i * 10;",
    "        i = i + 1;",
    "    }",
    "    ",
    "    printf(\"Array values: \");",
    "    i = 0;",
    "    loop (i < 5) {",
    "        printf(\"%d \", *(arr_ptr + i));",
    "        i = i + 1;",
    "    }",
    "    printf(\"\\n\");",
    "    free(cast<*void>(arr_ptr));",
    "    ",
    "    # Allocate a linked list node",
    "    local head: *Node = createNode(100);",
    "    printNodeValue(head);",
    "    ",
    "    # Create a second node and link it",
    "    local next: *Node = createNode(200);",
    "    head.next = next;",
    "    printf(\"Head value: %d, Next value: %d\\n\", head.value, head.next.value);",
    "    ",
    "    # Clean up",
    "    free(cast<*void>(next));",
    "    free(cast<*void>(head));",
    "    ",
    "    printf(\"Memory cleaned up\\n\");",
    "    return 0;",
    "}"
  ]
}
