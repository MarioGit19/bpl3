{
  "order": 34,
  "title": "Memory Management",
  "snippet": "Work with malloc, free, and memory allocation",
  "description": "BPL uses manual memory management - you control allocation and deallocation. malloc(size) allocates heap memory, returning void* (must cast). free(ptr) releases memory. Rules: every malloc needs a matching free, never use freed memory (use-after-free), don't free twice (double-free), don't free stack variables. Memory leaks occur when allocated memory is never freed. Use tools like valgrind to detect leaks. Strategies: RAII-style init/cleanup methods, ownership conventions, minimal malloc/free pairs. Heap memory persists until freed, unlike stack memory (auto-freed on scope exit). This example demonstrates safe memory management patterns and common pitfalls.",
  "code": "extern printf(fmt: string, ...);\nextern malloc(size: long) ret *void;\nextern free(ptr: *void);\n\n# Define a simple structure for dynamic allocation\nstruct Node {\n    value: int,\n    next: *Node,\n}\n\nframe createNode(value: int) ret *Node {\n    # Allocate memory for a Node\n    local size: long = sizeof(Node);\n    local ptr: *void = malloc(size);\n    \n    # Cast void pointer to Node pointer\n    local node: *Node = cast<*Node>(ptr);\n    \n    # Initialize the node\n    node.value = value;\n    node.next = nullptr;\n    \n    return node;\n}\n\nframe printNodeValue(node: *Node) ret void {\n    printf(\"Node value: %d\\n\", node.value);\n}\n\nframe main() ret int {\n    printf(\"=== Memory Allocation Example ===\\n\");\n    \n    # Allocate a single integer\n    local int_size: long = sizeof(int);\n    local int_ptr: *int = cast<*int>(malloc(int_size));\n    *int_ptr = 42;\n    printf(\"Allocated int: %d\\n\", *int_ptr);\n    free(cast<*void>(int_ptr));\n    \n    # Allocate an array of integers (5 elements)\n    local arr_size: long = sizeof(int) * 5;\n    local arr_ptr: *int = cast<*int>(malloc(arr_size));\n    local i: int = 0;\n    loop (i < 5) {\n        *(arr_ptr + i) = i * 10;\n        i = i + 1;\n    }\n    \n    printf(\"Array values: \");\n    i = 0;\n    loop (i < 5) {\n        printf(\"%d \", *(arr_ptr + i));\n        i = i + 1;\n    }\n    printf(\"\\n\");\n    free(cast<*void>(arr_ptr));\n    \n    # Allocate a linked list node\n    local head: *Node = createNode(100);\n    printNodeValue(head);\n    \n    # Create a second node and link it\n    local next: *Node = createNode(200);\n    head.next = next;\n    printf(\"Head value: %d, Next value: %d\\n\", head.value, head.next.value);\n    \n    # Clean up\n    free(cast<*void>(next));\n    free(cast<*void>(head));\n    \n    printf(\"Memory cleaned up\\n\");\n    return 0;\n}"
}
